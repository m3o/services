<!DOCTYPE html>

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description"
    content="">
<meta name="keywords" content="fault tolerance,  fault tolerance">


<title>Fault Tolerance | Micro</title>


<link rel="stylesheet" href="/docs/css/syntax.css">
<link rel="stylesheet" type="text/css"
    href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">


<link rel="stylesheet" href="/docs/css/customstyles.css?v=1">


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="/docs/js/jquery.navgoco.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="/docs/js/toc.js"></script>
<script src="/docs/js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="docs" href="https://micro.mu/docsfeed.xml">

    <script>
        $(document).ready(function () {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function (e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function (e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });
    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>

<body>
    <!-- Navigation -->
<div class="container">
	<nav class="navbar">
	    
	    <a class="navbar-brand" href="index.html">
		<img src="https://micro.mu/logo.png" height="50px" width="auto" /><span class="projectTitle"> Micro</span>
	    </a>
	    

	    <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse-1">
		<span class="sr-only">Toggle navigation</span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	    </button>

        <div class="collapse navbar-collapse" id="navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">English<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="/docs/index.html">English</a></li>
                        
                        
                        
                        <li><a href="/docs/cn/index.html">中文</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
            </ul>
        </div>
    </nav>
</div>

    <!-- Page Content -->
    <div class="container">
        <div class="col-lg-12">&nbsp;</div>
        <!-- Content Row -->
        <div class="row">
            <!-- Sidebar Column -->
            <div class="col-md-3">

                







<ul id="mysidebar" class="nav list-group">
    
    
    
        
    
    <li class="list-group-item">
        <a href="#" class="title">Overview</a>
        <ul>
            
            
            
            <li><a href="/docs/index.html">Introduction</a></li>
            
            
            
            
            
            
            <li><a href="/docs/faq.html">FAQ</a></li>
            
            
            
            
            
            
            <li><a href="/docs/features.html">Features</a></li>
            
            
            
            
            
            
            <li><a href="/docs/users.html">Users</a></li>
            
            
            
            
            
            
            <li><a href="/docs/resources.html">Resources</a></li>
            
            
            
            
        </ul>
        
        
    
    <li class="list-group-item">
        <a href="#" class="title">Getting Started</a>
        <ul>
            
            
            
            <li><a href="/docs/getting-started.html">Overview</a></li>
            
            
            
            
            
            
            <li><a href="/docs/installation.html">Installation</a></li>
            
            
            
            
            
            
            <li><a href="/docs/writing-a-go-service.html">Writing a Go Service</a></li>
            
            
            
            
            
            
            <li><a href="/docs/micro-service.html">Everything as a Service</a></li>
            
            
            
            
        </ul>
        
        
    
    <li class="list-group-item">
        <a href="#" class="title">Deployment</a>
        <ul>
            
            
            
            <li><a href="/docs/deploy-local.html">Local</a></li>
            
            
            
            
            
            
            <li><a href="/docs/deploy-docker.html">Docker</a></li>
            
            
            
            
            
            
            <li><a href="/docs/deploy-kubernetes.html">Kubernetes</a></li>
            
            
            
            
        </ul>
        
        
    
    <li class="list-group-item">
        <a href="#" class="title">Framework</a>
        <ul>
            
            
            
            <li><a href="/docs/framework.html">Overview</a></li>
            
            
            
            
            
            
            <li><a href="/docs/helloworld.html">Hello World</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-config.html">Config</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-errors.html">Errors</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-examples.html">Examples</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-api.html">API Handlers</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-internals.html">Internals</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-plugins.html">Plugins</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-pubsub.html">Pub Sub</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-web.html">Web Service</a></li>
            
            
            
            
            
            
            <li><a href="/docs/go-wrappers.html">Wrappers</a></li>
            
            
            
            
        </ul>
        
        
    
    <li class="list-group-item">
        <a href="#" class="title">Platform</a>
        <ul>
            
            
            
            <li><a href="/docs/platform.html">Overview</a></li>
            
            
            
            
            
            
            <li><a href="/docs/platform/getting-started.html">Get Started</a></li>
            
            
            
            
            
            
            <li><a href="/docs/platform/services.html">Services</a></li>
            
            
            
            
        </ul>
        
        
    
    <li class="list-group-item">
        <a href="#" class="title">Runtime</a>
        <ul>
            
            
            
            <li><a href="/docs/runtime.html">Overview</a></li>
            
            
            
            
            
            
            <li><a href="/docs/architecture.html">Architecture</a></li>
            
            
            
            
            
            
            <li><a href="/docs/api.html">API Gateway</a></li>
            
            
            
            
            
            
            <li><a href="/docs/web.html">Web Dashboard</a></li>
            
            
            
            
            
            
            <li><a href="/docs/debugging.html">Debugging</a></li>
            
            
            
            
            
            
            <li><a href="/docs/proxy.html">Service Proxy</a></li>
            
            
            
            
            
            
            <li><a href="/docs/service-network.html">Service Network</a></li>
            
            
            
            
            
            
            <li><a href="/docs/tunnel.html">Service Tunnel</a></li>
            
            
            
            
            
            
            <li><a href="/docs/cli.html">Command Line</a></li>
            
            
            
            
            
            
            <li><a href="/docs/bot.html">Slack Bot</a></li>
            
            
            
            
            
            
            <li><a href="/docs/new.html">New Template</a></li>
            
            
            
            
            
            
            <li><a href="/docs/run-service.html">Run Service</a></li>
            
            
            
            
        </ul>
        
        
    
    <li class="list-group-item">
        <a href="#" class="title">Network</a>
        <ul>
            
            
            
            <li><a href="/docs/network.html">Overview</a></li>
            
            
            
            
        </ul>
        
        
    
    <li class="list-group-item">
        <a href="#" class="title">Plugins</a>
        <ul>
            
            
            
            <li><a href="/docs/plugins.html">Overview</a></li>
            
            
            
            
            
            
            <li><a href="/docs/plugins-framework.html">Framework</a></li>
            
            
            
            
            
            
            <li><a href="/docs/plugins-runtime.html">Runtime</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

                <!-- Content Column -->
                <div class="col-md-9">
                    <div class="post-header">
   <h1 class="post-title-main">Fault Tolerance</h1>
</div>



<div class="post-content">

   

    

  <p>In a distributed systems world failures are occurring all the time. Micro attempts to address this with some best practices for fault tolerance. 
This document describes some of the ways in which they can be configured.</p>

<h2 id="heartbeating">Heartbeating</h2>

<p>Heartbeating is a mechanism of refreshing registration in service discovery.</p>

<h3 id="rationale">Rationale</h3>

<p>Services register with service discovery on startup and deregister on shutdown. Sometimes these services may unexpectedly die, 
be killed forcefully or face transient network issues. In these cases stale nodes will be left in service discovery. It would be 
ideal if services were automatically removed.</p>

<h3 id="solution">Solution</h3>

<p>Micro supports the option of a register TTL and register interval for this exact reason. TTL specifies how long a registration should 
exist in discovery after which it expires and is removed. Interval is the time at which a service should re-register to preserve 
it’s registration in service discovery.</p>

<p>These are options made available in go-micro and as flags in the micro toolkit</p>

<h3 id="usage">Usage</h3>

<p>For the micro toolkit simply use the built in flags to set ttl and interval.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>micro --register_ttl=30 --register_interval=15 api
</code></pre></div></div>

<p>This example shows that we’re setting a ttl of 30 seconds with a re-register interval of 15 seconds.</p>

<p>For go-micro, when declaring a micro service you can pass in the options as time.Duration</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service := micro.NewService(
        micro.Name("com.example.srv.foo"),
        micro.RegisterTTL(time.Second*30),
        micro.RegisterInterval(time.Second*15),
)
</code></pre></div></div>

<h2 id="load-balancing">Load Balancing</h2>

<p>Load balancing is a way of spreading request load or maintaining high availability</p>

<h3 id="rationale-1">Rationale</h3>

<p>There are limitations to availability and scaling with any single process application. If an application dies for any reason 
you are no longer able to serve requests. If enough request load is sent to the application it may begin to respond slowly 
or not at all. Sending requests across multiple copies of an application would solve these problems.</p>

<h3 id="solution-1">Solution</h3>

<p>Micro does client side load balancing via the <a href="https://pkg.go.dev/github.com/micro/go-micro/v2/selector#Selector">selector</a> interface 
to spread requests across any number of nodes of a service. When a service is started it registers with service discovery as a 
service node with a unique address and id. When making a request the micro client uses the selector to decide which node to make 
the request to. The selector uses the service registry to find the nodes of a service, then use a load balancing strategy such as 
random hash or round robin to select a node to send the request to.</p>

<h3 id="usage-1">Usage</h3>

<p>Client side load balancing is built into the go-micro client. This is done automatically.</p>

<h2 id="retries">Retries</h2>

<p>Retries are a method of retrying a request if it was unsuccessful</p>

<h3 id="rationale-2">Rationale</h3>

<p>A request may fail for any number of reasons; network error, request load, application death. In these instances it would be ideal 
if we could retry the request against a different copy of the application to receive a successful response.</p>

<h3 id="solution-2">Solution</h3>

<p>The micro client includes a mechanism for retrying requests. The selector (mentioned above) returns a Next function which when executed 
uses a load balancing strategy to return a node from the list. The Next function can be executed multiple times, returning a new node 
based on the load balancing strategy. With retries set, if a request fails, the Next function will be executed and the request 
will be retried against a new node.</p>

<h3 id="usage-2">Usage</h3>

<p>Retries can be set as a flag or option to the client. It defaults to 1, meaning 1 attempt at a request.</p>

<p>To change via flag</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>micro --client_retries=3
</code></pre></div></div>

<p>To set as an option</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>client.Init(
	client.Retries(3),
)
</code></pre></div></div>

<h2 id="caching-discovery">Caching Discovery</h2>

<p>A discovery cache is a client side cache of service discovery information</p>

<h3 id="rationale-3">Rationale</h3>

<p>Service discovery is the core dependency of microservices but can also become a single point of failure if not architected correctly. Every 
discovery system has its own properties for scaling and high availability. In the event discovery goes down it makes the rest of the system 
unusable as services do not know how to resolve names to addresses. Discovery can also be a bottleneck if a lookup is done for every 
request in the system.</p>

<h3 id="solution-3">Solution</h3>

<p>Client side caching is a method of eliminating service discovery as a bottleneck and single point of failure. Micro includes a selector 
(client side load balancer) which maintains an in memory cache of service discovery information relevant to it. If a cache miss occurs 
the selector will use the service registry to do a lookup and cache the data. The cache is also periodically TTLed out to ensure 
stale data does not live on.</p>

<h3 id="usage-3">Usage</h3>

<p>The caching selector can be set by flag or when creating a new service.</p>

<p>As a flag with the toolkit do the following</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>micro --selector=cache api
</code></pre></div></div>

<p>Go-micro services can also use the same flag if the Init method is called. Alternatively the selector can be set in code.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import (
	"github.com/micro/go-micro/v2/client"
	"github.com/micro/go-micro/v2/selector/cache"
)

service := micro.NewService(
	micro.Name("com.example.srv.foo"),
)

service.Client().Init(cache.NewSelector())
</code></pre></div></div>



<!--
    <div class="tags">
        
        
        
        
        
        
    </div>
-->
    

</div>

<hr class="faded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy; 2020 Micro Services, Inc.<br />
 Last generated: May 4, 2020 <br />
                </div>
            </div>
</footer>


                </div>
                <!-- /.row -->
            </div>
            <!-- /.container -->
        </div>
    </div>
</body>

<!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-70478210-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>



</html>